<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/styles.css"><title>初识Core Data | ANANWBR's</title></head><body><div class="container"><div class="columns page-header"><h1>ANANWBR's</h1></div><div class="columns"><div class="navigation"><nav class="menus-main"><a href="/" class="favicon"><img alt="ANANWBR's" src="/favicon.png"></a><a href="/">Home</a></nav></div></div><div class="columns"><div class="block-body column three-fourths"><article><header><small class="right"></small><h2>初识Core Data</h2></header><div class="article-meta clearfix"><time class="left">2014-06-25</time><ul class="tags left"><li><a href="/categories/技术/">技术</a></li></ul><ul class="tags right"><li><a href="/tags/iOS/">iOS</a></li></ul></div><div class="markdown-body"><p>Core Data一直以来都是我比较怕的一块，每次涉及到这一块内容，我总是底气不足，总觉得它是很复杂的东西我搞不定。从开始实习到现在已经两年时间了，技术水平提高了很多，但单从对这个知识点的掌握程度来看，水平提高基本是停滞的。期间曾多次决定好好研究一下，但中途都放弃了，还会以在心里默念“果然CoreData对我来说难度好高啊”来结尾。这应该是唯一一个让我这么没有耐心和决心的知识点吧。最近做的项目再一次广泛用到了Core Data，终于让我下定决心要把它搞清楚，至少消除害怕的心里。</p>
<p>下面进入正题吧，这篇文章主要是讲一下Core Data的一些基本概念和用法。</p>
<h2 id="Core_Data_u662F_u4EC0_u4E48"><a href="#Core_Data_u662F_u4EC0_u4E48" class="headerlink" title="Core Data是什么"></a>Core Data是什么</h2><p>我们在开发iOS应用的时候，需要把一些数据持久化存储起来，有多种方法可以做到这点，比如属性列表(Property lists)，对象归档(Object archiving)，SQlite数据库，Core Data等。而我们今天要讲的Core Data，它又不仅仅是一种数据持久化的技术。它除了数据的存取功能之外，还能管理被加载到内存中的数据。具体来说，</p>
<ul>
<li>它能管理模型对象所有的更改，给undo和redo操作，以及维护对象之间的相互关系提供了支持。</li>
<li>在任意时刻只在内存中保留所有模型对象的一个子集，这对内存有限的iOS来说是非常重要的。</li>
<li>使用一个模式(schema)来描述模型对象。我们可以在图形界面编辑器种直接定义模型类的主要特征，包括对象之间的关系。也可以很方便的设置默认值以及属性值验证。</li>
<li>提供了对数据模型版本变迁的支持，使得我们很容易升级数据模型版本。<!--
4.Allows you to maintain disjoint sets of edits of your objects. This is useful if you want to, for example, allow the user to make edits in one view that may be discarded without affecting data displayed in another view.
-->
</li>
</ul>
<p>简而言之，Core Data就是一个模式驱动(schema-driven)的对象图管理和数据持久化的框架。</p>
<h2 id="Core_Data_u5806_u6808"><a href="#Core_Data_u5806_u6808" class="headerlink" title="Core Data堆栈"></a>Core Data堆栈</h2><p>Core Data使用了多个组件来完成对象图管理和持久化的工作。这些组件组合到一起就被称为Core Data堆栈了。下面就是一个简单的堆栈的图示：当然在实际应用中，使用的堆栈可能要比这个复杂的多，可能存在多个Managed Object Context</p>
<p><img src="/images/2014/6/Core_Data_Stack.png" alt=" A simple Core Data stack"></p>
<p>可以从图中看出，各组件的层次是很分明的。Managed Object Context负责对象图管理，Persistent Object Store负责持久化，两者之间的沟通需要通过Persistent Store Coordinator协调，另外还有一个Managed Object Model来为数据建模。</p>
<p>接下来我们就来具体了解一下各个组件。</p>
<h3 id="Managed_Objects_and_the_Managed_Object_Context"><a href="#Managed_Objects_and_the_Managed_Object_Context" class="headerlink" title="Managed Objects and the Managed Object Context"></a>Managed Objects and the Managed Object Context</h3><p>Managed Objects和Managed Object Context处于堆栈的顶部，也是通常我们直接会接触的对象。</p>
<p>一个managed object是NSManagedObject或它的子类的一个实例对象。从概念上来讲，它是数据库的表中一条记录的对象化表示，是我们的应用中需要操作的数据，比如人力资源应用中的部门和员工。一个managed object总是和一个managed object context关联。</p>
<p>一个managed object context是NSManagedObjectContext的一个实例对象。它代表了一个对象空间，是managed object生存的地方。它的主要职责就是管理内存中的managed object的生存周期，除此之外，它还负责属性验证，维护对象间关系和undo/redo等。</p>
<p>当我们创建一个新的managed object的时候，我们将它插入到managed context中。我们也可以把数据库中的记录取出来转换成managed object放到context中。对内存中的managed object的任何操作都会被保留，直到将更改提交到持久化存储中。</p>
<p><img src="/images/2014/6/managed_objects.png" alt="Managed objects in a context, and a table in the persistent store"></p>
<h3 id="The_Managed_Object_Model"><a href="#The_Managed_Object_Model" class="headerlink" title="The Managed Object Model"></a>The Managed Object Model</h3><p>一个managed object model是NSManagedObjectModel的一个实例对象。它是对数据库和managed object的描述。一个model是很多entity description对象(NSEntityDescription的实例)的集合。一个entity description描述了一个实体(数据库中的一张表)的名字，对应的NSManagedObject子类的名字，以及它拥有的属性和关系。</p>
<p>下图描述了一个entity description，数据库中的一张表和表中的一条记录对应的一个managed object之间的关系：</p>
<p><img src="/images/2014/6/mageed_object_model.png" alt=" An entity description, a table in the database, and a managed object"></p>
<p>Core Data就是这样使用模型将应用中的managed object映射到数据库中的记录的。需要注意的是如果我们修改了模型，那么Core Data将无法读取使用就得模型持久化存储的数据。这时候就需要用到“数据模型版本变迁”的知识，这里暂不赘述。</p>
<h3 id="Persistent_Store_Coordinator"><a href="#Persistent_Store_Coordinator" class="headerlink" title="Persistent Store Coordinator"></a>Persistent Store Coordinator</h3><p>前面已经说过persistent store coordinator架起了persistent store和managed object context之间的桥梁，在Core Data管理数据的过程发挥了核心作用。</p>
<p>一个persistent store coordinator是NSPersistentStoreCoordinator的一个实例对象。它管理着多个persistent object store。一个persistent object store代表持久化的数据的一个外部存储(文件)。前面我们一直在用数据库来表示外部存储，实际上Core Data也支持其他类型的文件系统。我们甚至也可以实现自定义的文件类型</p>
<p>到目前为止我们只是看了最简单的一个堆栈。在实际应用中，我们可能会遇到更复杂的，比如有多个context，或是多个store，但它们都还是和同一个coordinator连接起来，这时候就更能体现它的核心作用了。</p>
<p><img src="/images/2014/6/complex_stack.png" alt="A complex Core Data stack"></p>
<p>到这里，我们就大致了解完了Core Data堆栈中的各个组件啦，下面是在应用中搭建这个堆栈的实际代码。</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@interface</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSManagedObjectModel</span> *managedObjectModel;  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSManagedObjectContext</span> *managedObjectContext;  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) <span class="built_in">NSPersistentStoreCoordinator</span> *persistentStoreCoordinator;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//@implementation</span></span><br><span class="line"><span class="preprocessor">#pragma mark - Core Data stack</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSManagedObjectContext</span> *)managedObjectContext</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_managedObjectContext != <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _managedObjectContext;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *coordinator = [<span class="keyword">self</span> persistentStoreCoordinator];</span><br><span class="line">    <span class="keyword">if</span> (coordinator != <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _managedObjectContext = [[<span class="built_in">NSManagedObjectContext</span> alloc] init];</span><br><span class="line">        [_managedObjectContext setPersistentStoreCoordinator:coordinator];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _managedObjectContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSManagedObjectModel</span> *)managedObjectModel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_managedObjectModel != <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _managedObjectModel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSURL</span> *modelURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"ebook"</span> withExtension:<span class="string">@"momd"</span>];</span><br><span class="line">    _managedObjectModel = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</span><br><span class="line">    <span class="keyword">return</span> _managedObjectModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSPersistentStoreCoordinator</span> *)persistentStoreCoordinator</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_persistentStoreCoordinator != <span class="literal">nil</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _persistentStoreCoordinator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSURL</span> *storeURL = [[<span class="keyword">self</span> applicationDocumentsDirectory] URLByAppendingPathComponent:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@.sqlite"</span>, _bookName]];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    _persistentStoreCoordinator = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:[<span class="keyword">self</span> managedObjectModel]];</span><br><span class="line">    <span class="built_in">NSDictionary</span> *options = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:</span><br><span class="line">                             [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>], <span class="built_in">NSMigratePersistentStoresAutomaticallyOption</span>,</span><br><span class="line">                             [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>], <span class="built_in">NSInferMappingModelAutomaticallyOption</span>, <span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![_persistentStoreCoordinator addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:options error:&amp;error])</span><br><span class="line">    &#123;</span><br><span class="line">        DLog(<span class="string">@"Unresolved error %@, %@"</span>, error, [error userInfo]);</span><br><span class="line">        abort();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSFetchRequest</span></span><br><span class="line">    <span class="keyword">return</span> _persistentStoreCoordinator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - Application's Documents directory</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURL</span> *)applicationDocumentsDirectory</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [[[<span class="built_in">NSFileManager</span> defaultManager] URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] lastObject];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u7ED3_u675F_u8BED"><a href="#u7ED3_u675F_u8BED" class="headerlink" title="结束语"></a>结束语</h2><p>本篇文章主要介绍了Core Data的功能，堆栈以及各组间，帮助我们在概念层面先理清楚它的结构。其实这几天我也看了很多Core Data的资料，还有很多知识点可以写，后面可能还会继续写几篇。对我个人来说，先宏观的学习一个知识点，了解背景，整体结构等，对后续的学习很有帮助。我开头就讲到对Core Data我还是比较怵的，每次用到的时候，都是查看文档使用那几个类和方法，虽然解决了问题但也总觉得心虚。比如前面的那段代码，以前看到就只是一段代码，现在再看的话脑子会浮现堆栈结构图。在进行数据操作的时候也可以理解内在的工作流程，如果遇到更难的问题也能在现在的认知基础上学习更深入的知识啦。</p>
<p>今后的文章主题，不再刻意去找了。当前学习了什么知识点，有哪些收获，就及时记录下来吧。</p>
<h2 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://www.objc.io/issue-4/core-data-overview.html" target="_blank" rel="external">Core Data Overview</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreData/cdProgrammingGuide.html" target="_blank" rel="external">Core Data Programming Guide</a></li>
</ol>
</div></article></div><div class="block-sidebar column one-fourth"><div class="widget tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/总结/">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul></div><div class="widget archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">三月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">一月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">十二月 2011</a><span class="archive-list-count">1</span></li></ul></div><div class="widget text-content"><p>© 2015 ananwbr <br>
Powered by &nbsp;<a href="http://hexo.io">Hexo</a></p></div></div></div></div></body></html>