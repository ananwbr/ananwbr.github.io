<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/styles.css"><title>iOS7多任务增强（3） | ANANWBR's</title></head><body><div class="container"><div class="columns page-header"><h1>ANANWBR's</h1></div><div class="columns"><div class="navigation"><nav class="menus-main"><a href="/" class="favicon"><img alt="ANANWBR's" src="/favicon.png"></a><a href="/">Home</a></nav></div></div><div class="columns"><div class="block-body column three-fourths"><article><header><small class="right"></small><h2>iOS7多任务增强（3）</h2></header><div class="article-meta clearfix"><time class="left">2013-08-23</time><ul class="tags left"><li><a href="/categories/技术/">技术</a></li></ul><ul class="tags right"><li><a href="/tags/iOS/">iOS</a></li></ul></div><div class="markdown-body"><p>今天终于做了分享了。分享之前还挺紧张的，不过开讲之后思路跟上了，又因为准备还算充分，所以整个过程还比较流畅。其实分享还是挺有趣的。借着分享的机会可以深入一个话题然后再和小伙伴们分享，讨论。是个学习、自我巩固、查漏补缺的好机会。</p>
<p>下面几点就是在分享过程中小伙伴们提出的疑问而我自己也不够确定的地方。后来又查看了相关知识，整理了一下给他们发了邮件。顺便也记录在这里。</p>
<h2 id="u591A_u4EFB_u52A1_u589E_u5F3A_u7684_u51E0_u70B9_u8865_u5145"><a href="#u591A_u4EFB_u52A1_u589E_u5F3A_u7684_u51E0_u70B9_u8865_u5145" class="headerlink" title="多任务增强的几点补充"></a>多任务增强的几点补充</h2><ol>
<li><p>关于<br> application:performFetchWithCompletionHandler:<br> application:didReceiveRemoteNotification:fetchCompletionHandler:<br> application:handleEventsForBackgroundURLSession:completionHandler:<br> 这三个方法可用的时间，文档中有这么一段话：</p>
<blockquote>
<p>When this method is called, your app has up to 30 seconds of wall-clock time to perform the download operation and call the specified completion handler block. In practice, your app should call the handler block as soon as possible after downloading the needed data. If you do not call the handler in time, your app is suspended. More importantly, the system uses the elapsed time to calculate power usage and data costs for your app’s background downloads.</p>
</blockquote>
<p> 也就是说，是执行完所有任务只有30秒的时间。就算你是异步执行，如果你没有在规定的时间内调用completion handler block告诉系统你已经完成任务，那么系统就会判定你已经超时，这时候就会挂起你的应用。另外系统会根据执行任务所用的时间来计算应用消耗的电量和流量。这些计算结果会影响应用被调度的机会。消耗越少，以后可能被调度到的机会就越大。</p>
</li>
<li><p>补充：在Debug应用的Background Fetch模式的时候，需要考虑两种情况：</p>
<ul>
<li>应用未启动，此时系统会启动应用并进入后台。选择一个Scheme然后Edit-&gt;左侧栏Run SimpleBackground…-&gt;Options-&gt;勾选Launch Due to a Background Fetch Event，这时候再在模拟器启动的话，应用会直接进入后台。</li>
<li><p>应用处于睡眠状态（在后台），此时系统会唤醒应用。Debug-&gt;Simulate Background Fetch<br>从Debug有两种方式说明，应用即使没启动的时候也会被调度。<br>但是如果在设置（Settings）的Background App Refresh中关掉了，或者这个应用是从App Switcher中被用户手动终止的，那么就算的之前注册了后台模式，也没有机会被调度到。</p>
<p>我之前的疑惑点是，应用处于未启动的状态，有哪几种情况呢。<br>1、从未启动：那它也没有向系统注册过后台模式，不会被调度。<br>2、启动过但被用户从App Swicher中终止，此时系统会尊重用户选择，也不会调度该应用。<br>3、启动过被系统强制退出：这时候应该有机会被调度吧。<br>4、还有其它情况吗？<br>如果没有其它情况，那说明Launch Due to a Background Fetch Event只会发生在第三种情况。<br>如果你们还知道其他情况，记得告诉我。</p>
</li>
</ul>
</li>
<li><p>关于Background Transfer Service<br>要说明一下这个部分并不是后台模式的一种，不管在foreground还是background，都可以创建NSURLSession并提交任务。经常与fetch和remote-notification模式结合使用。iOS 7之前的应用可以通过Background Task Completion在后台继续运行一段时间来下载，但如果因为各种原因而导致应用被退出了（被用户杀掉，内存不足或超时被系统杀掉等），那么下载是得不到保证的。iOS 7的后台传输服务则可以让系统去下载，出错或下完后通知并唤醒应用来处理。另外，为了避免浪费流量，该服务只会在 WiFi 环境下才进行传输。</p>
<p> 关于NSURLSession和NSURLSessionTask，是分别有NSURLSessionDelegate和NSURLSessionTaskDelegate。参考文档中的这段：</p>
<blockquote>
<p>If a URL session finishes its work when your app is <strong>not running</strong>, the system launches your app in the background so that it can process the event. In that situation, use the provided identifier to create a new NSURLSessionConfiguration and NSURLSession object. You must configure the other options of your NSURLSessionConfiguration object in the same way that you did when you started the uploads or downloads. Upon creating and configuring the new NSURLSession object, that object calls the appropriate delegate methods to process the events.</p>
<p>If your app already has a session object with the specified identifier and is <strong>running or suspended</strong>, you do not need to create a new session object using this method. Suspended apps are moved into the background. As soon as the app is running again, the NSURLSession object with the identifier receives the events and processes them normally.</p>
<p>At <strong>launch time</strong>, the app does not call this method if there are uploads or downloads in progress but not yet finished. If you want to display the current progress of those transfers in your app’s user interface, you must recreate the session object yourself. In that situation, cache the identifier value persistently and use it to recreate your session object.</p>
</blockquote>
<p> 当NSURLSession里的所有任务都完成时    </p>
<ul>
<li>如果此时应用没在运行，那么系统会启动应用（参考上面第2点）进入bakground状态，此时我们需要根据identifier重建session对象，然后该对象会调用合适的delegate方法处理时间。</li>
<li><p>如果此时应用在Suspended状态，那么系统让应用进入Background状态，调用application:handleEventsForBackgroundURLSession:completionHandler:方法，然后该identifier代表的session对象就会收到事件从而调用合适的delegate方法。</p>
<p>更多的情况可参考《What’s New in Foundation Networking》这个session。具体细节有待研究。</p>
</li>
</ul>
</li>
<li><p>关于系统如何判断是哪种通知，应该是根据content-available这参数来的。</p>
</li>
</ol>
<figure class="highlight nimrod"><table><tr><td class="code"><pre><span class="line">//<span class="type">Normal</span> <span class="type">Remote</span> <span class="type">Notification</span></span><br><span class="line">     aps &#123;</span><br><span class="line">          alert: <span class="decorator">&#123;...&#125;</span></span><br><span class="line">     &#125;</span><br><span class="line">//<span class="type">Remote</span> <span class="type">Push</span> <span class="type">Notification</span></span><br><span class="line">     aps &#123;</span><br><span class="line">          content-available: <span class="number">1</span></span><br><span class="line">          alert: <span class="decorator">&#123;...&#125;</span></span><br><span class="line">     &#125;</span><br><span class="line">//<span class="type">Silent</span> <span class="type">Push</span> <span class="type">Notification</span></span><br><span class="line">     aps &#123;</span><br><span class="line">          content-available: <span class="number">1</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<h2 id="u7ED3_u675F_u8BED"><a href="#u7ED3_u675F_u8BED" class="headerlink" title="结束语"></a>结束语</h2><p>这周时间比较紧张，上班时间完全专心于新项目的开发。需要处理一些以前没遇到过的情况，也是个学习的好机会。但是这周工作之余的时间安排的不是很好。下了班总感觉很累，没有精力继续研究。这种情况下就干脆早点躺床上看书去了。我在想是不是上周六两点左右才睡的后遗症。我是老了么，一次熬夜就这么损。除了心理上的疲惫还有身体上的疼痛。因为最近几天不是下雨就是刮很大的风本来想的下班后跑步一直没有执行，于是周三就在室内跳了操，做了几个卷腹，结果一直腰酸背疼。看来最近体能也差了。好怀念三、四月份那会儿还在学校的时候晚上去操场跑步40分钟+20分钟拉伸之后大汗淋漓的感觉。那时候一天不出去运动就心里痒痒。结果因为回家休息断了之后要重新开始还是有点困难。</p>
<p>趁着周末好好调整一下~</p>
</div></article></div><div class="block-sidebar column one-fourth"><div class="widget tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/总结/">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul></div><div class="widget archives"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">六月 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">六月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">五月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">四月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">三月 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">一月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">十二月 2011</a><span class="archive-list-count">1</span></li></ul></div><div class="widget text-content"><p>© 2015 ananwbr <br>
Powered by &nbsp;<a href="http://hexo.io">Hexo</a></p></div></div></div></div></body></html>